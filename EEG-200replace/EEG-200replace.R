library(openxlsx)

Sys.setenv(R_ZIPCMD= "C:/Rtools/bin/zip")

setwd('Z:/IrinaEEG/')

files = list.files(pattern="*.xlsx")
for (i in 1:length(files)) assign(files[i], read.xlsx(files[i], sheet=3))

# example df: B_AB.xlsx
# df = B_AB.xlsx

# which(df$Time==-200)
# [1]    101   1339   2577   3815   5053   6291   7529   8767  10005  11243  12481  13719  14957  16195  17433  18671  19909
# [18]  21147  22385  23623  24861  26099  27337  28575  29813  31051  32289  33527  34765  36003  37241  38479  39717  40955
# [35]  42193  43431  44669  45907  47145  48383  49621  50859  52097  53335  54573  55811  57049  58287  59525  60763  62001
# [52]  63239  64477  65715  66953  68191  69429  70667  71905  73143  74381  75619  76857  78095  79333  80571  81809  83047
# [69]  84285  85523  86761  87999  89237  90475  91713  92951  94189  95427  96665  97903  99141 100379 101617 102855 104093
# [86] 105331 106569 107807 109045 110283 111521 112759 113997 115235 116473 117711 118949 120187 121425 122663

# which(df$Time==0)
# [1]    126   1364   2602   3840   5078   6316   7554   8792  10030  11268  12506  13744  14982  16220  17458  18696  19934
# [18]  21172  22410  23648  24886  26124  27362  28600  29838  31076  32314  33552  34790  36028  37266  38504  39742  40980
# [35]  42218  43456  44694  45932  47170  48408  49646  50884  52122  53360  54598  55836  57074  58312  59550  60788  62026
# [52]  63264  64502  65740  66978  68216  69454  70692  71930  73168  74406  75644  76882  78120  79358  80596  81834  83072
# [69]  84310  85548  86786  88024  89262  90500  91738  92976  94214  95452  96690  97928  99166 100404 101642 102880 104118
# [86] 105356 106594 107832 109070 110308 111546 112784 114022 115260 116498 117736 118974 120212 121450 122688

# if all datasheets are the same, these numbers should be the same across all df's

# which(B_CM.xlsx$Time==-200)
# [1]    101   1339   2577   3815   5053   6291   7529   8767  10005  11243  12481  13719  14957  16195  17433  18671  19909
# [18]  21147  22385  23623  24861  26099  27337  28575  29813  31051  32289  33527  34765  36003  37241  38479  39717  40955
# [35]  42193  43431  44669  45907  47145  48383  49621  50859  52097  53335  54573  55811  57049  58287  59525  60763  62001
# [52]  63239  64477  65715  66953  68191  69429  70667  71905  73143  74381  75619  76857  78095  79333  80571  81809  83047
# [69]  84285  85523  86761  87999  89237  90475  91713  92951  94189  95427  96665  97903  99141 100379 101617 102855 104093
# [86] 105331 106569 107807 109045 110283 111521 112759 113997 115235 116473 117711 118949 120187 121425 122663

# which(B_CM.xlsx$Time==0)
# [1]    126   1364   2602   3840   5078   6316   7554   8792  10030  11268  12506  13744  14982  16220  17458  18696  19934
# [18]  21172  22410  23648  24886  26124  27362  28600  29838  31076  32314  33552  34790  36028  37266  38504  39742  40980
# [35]  42218  43456  44694  45932  47170  48408  49646  50884  52122  53360  54598  55836  57074  58312  59550  60788  62026
# [52]  63264  64502  65740  66978  68216  69454  70692  71930  73168  74406  75644  76882  78120  79358  80596  81834  83072
# [69]  84310  85548  86786  88024  89262  90500  91738  92976  94214  95452  96690  97928  99166 100404 101642 102880 104118
# [86] 105356 106594 107832 109070 110308 111546 112784 114022 115260 116498 117736 118974 120212 121450 122688

# and they are the same, great!

# What is the fixed difference (in rows) between the onsets of new phases?

1339 - 101 # = 1238
2602 - 1364 # = 1238
110283 - 109045 # = 1238

# and the number of rows between -200 and start?

126 - 101 # = 25



replace200 <- function(df){
  
  marks = which(df$Time==-200) # finds all the rows where t = -200
  #marks = marks[-1] # removes the first row which we have used for the baseline
  
  for (i in 1:length(marks)){  # should be 99 long
    
    f200 <- df[c(marks[i]:(marks[i]+25)),2:8] # captures -200 to 0, inclusive
    #               -200            0
#    1714 : 1739
    
    df[c((marks[i]+375):(marks[i]+400)),2:8] <- df[c(marks[i]:(marks[i]+25)),2:8] #f200
    #             2800           3000
    
  }
  
  return(df)
  
}


## Testing that it works:
#
# df = B_AB.xlsx
# df <- replace200(df)
# 
# df[c(101:105),]
# df[c(476:480),]
# df[c(476:480),] <- df[c(101:105),]
# df[c(476:480),]



#x = replace200(eval(parse(text = files[i])))




for (i in 1:length(files)){
  
  assign(files[i], replace200(eval(parse(text = files[i]))))
  
  #addWorksheet(paste(files[i]), 'modified')
  # write.xlsx(x = eval(parse(text = files[i])), paste(files[i]), overwrite = T, sheetName = 'modified')
  
  wbt = loadWorkbook(paste(files[i]))
  addWorksheet(wbt, "modified")
  writeData(wbt, sheet = "modified", x = eval(parse(text = files[i])))
  saveWorkbook(wbt,paste(files[i]),overwrite = T)
  
}







